<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>canvas自主练习一</title>
		<style>
			*{margin: 0;padding: 0;}
			.main{width: 500px;height: 500px;margin: 50px auto 20px auto;border: 1px dashed #b3b3b3;border-radius: 20px;overflow: hidden;}
			.img{width: 500px;height: auto;margin: 0 auto;display: flex;flex-wrap: nowrap;justify-content: center;}
			.img input{margin-bottom: 5px;}
			.bthImge-1,.bthImge-2{width: 150px;height: 45px;text-align: center;line-height: 45px;background-color: #0ca553;font-size: 14px;color: #fff;border-radius: 8px;margin: 0 10px;}
		</style>
	</head>
	<body>
		<div class="main">
			<canvas id="canvas" width="500" height="500"></canvas>
		</div>
		<div class="img">
			<input type="file" id="fileInput-1" accept="image/*" hidden>
			<input type="file" id="fileInput-2" accept="image/*" hidden>
			<div class="bthImge-1">上传主图</div>
			<div class="bthImge-2">上传小图</div>
		</div>
	</body>
	<script>
		var bthImge_1 = document.querySelector(".bthImge-1");	//获取上传主图按钮
		var bthImge_1_fun = document.querySelector("#fileInput-1");	//获取上传主图input
		var bthImge_2 = document.querySelector(".bthImge-2");	//获取上传主图按钮
		var bthImge_2_fun = document.querySelector("#fileInput-2");	//获取上传主图input
		
		bthImge_1.onclick = function(){	//将模拟的按钮和input绑定在一起
			triggerOnClick(bthImge_1_fun)
		}
		bthImge_2.onclick = function(){	//将模拟的按钮和input绑定在一起
			triggerOnClick(bthImge_2_fun)
		}
		
		// 添加一个函数来触发点击事件
		function triggerOnClick(element) {
			element.click();
		}
		
		
		
		var canvas = document.querySelector("#canvas");
		// if(!canvas.getContext) return;	//会出错，还不知道什么问题
		var ctx = canvas.getContext("2d");	//创建2D画布
		var img = new Image();	//创建一个图片
		
		
		
		// 上传主图canvas
		// 为 input 元素添加 change 事件监听器
		bthImge_1_fun.addEventListener('change', function(event){
		    // 获取用户选择的文件
		    const file = event.target.files[0];
		    // 检查文件是否存在且为图片类型
		    if (file && file.type.startsWith('image/')){
		        // 创建一个 FileReader 对象
		        const reader = new FileReader();
		        // 为 FileReader 添加 load 事件监听器
		        reader.onload = function(e){
		            // 将读取到的图片数据设置为 img 元素的 src 属性，实现图片预览
		            // preview.src = e.target.result;
					
					// 这里实现在canvas画布预览
					img.crossOrigin = "anonymous"; // 添加这一行:在图像加载到 canvas 之前，设置 img 元素的 crossOrigin 属性为 "anonymous"，以允许跨域访问。但请注意，这需要图像服务器支持 CORS。否则影响toDataURL无法下载
					img.src = e.target.result;	//图片路径
					
					img.onload = function(){	//如果在图片加载完成之前就尝试绘制到Canvas上，图片将不会显示。确保在图片的onload事件中绘制图片
						ctx.drawImage(img,0,0,500,500) //绘制img,设置坐标。drawImage(image, x, y, width, height)
					}
					
					try{
					    var dataURL = canvas.toDataURL();
					    // 现在可以使用 dataURL 进行下载或其他操作
					} catch (error) {
					    console.error("跨域问题导致 toDataURL 失败:", error);
					}
		        };
		        // 使用 FileReader 读取文件并将结果作为数据 URL 返回
		        reader.readAsDataURL(file);
		    } else {
		        // 如果选择的不是图片，清空 img 元素的 src 属性
		        preview.src = '';
		    }
		});
		
		// 上传小图canvas
		// 为 input 元素添加 change 事件监听器
		bthImge_2_fun.addEventListener('change', function(event){
		    // 获取用户选择的文件
		    const file = event.target.files[0];
		    // 检查文件是否存在且为图片类型
		    if (file && file.type.startsWith('image/')){
		        // 创建一个 FileReader 对象
		        const reader = new FileReader();
		        // 为 FileReader 添加 load 事件监听器
		        reader.onload = function(e){
		            // 将读取到的图片数据设置为 img 元素的 src 属性，实现图片预览
		            // preview.src = e.target.result;
					
					// 这里实现在canvas画布预览
					img.crossOrigin = "anonymous"; // 添加这一行:在图像加载到 canvas 之前，设置 img 元素的 crossOrigin 属性为 "anonymous"，以允许跨域访问。但请注意，这需要图像服务器支持 CORS。否则影响toDataURL无法下载
					img.src = e.target.result;	//图片路径
					
					img.onload = function(){	//如果在图片加载完成之前就尝试绘制到Canvas上，图片将不会显示。确保在图片的onload事件中绘制图片：
						ctx.drawImage(img,0,0,500,200) //绘制img,设置坐标。drawImage(image, x, y, width, height)
						
						ctx.fillStyle = "rgba(0,0,0,0.65)";
						ctx.fillRect(0,0,500,200);
						
						ctx.fillStyle = "rgba(255,255,255,1)";
						ctx.font = "20px sans-serif"	//创建文字
						ctx.fillText("这个夏天",70,90)	//文字内容与坐标
						ctx.font = "12px sans-serif"	//创建文字
						ctx.fillText("让我们一起踏上旅行吧！",70,120)	//文字内容与坐标
					}
					try{
					    var dataURL = canvas.toDataURL();
					    // 现在可以使用 dataURL 进行下载或其他操作
					} catch (error) {
					    console.error("跨域问题导致 toDataURL 失败:", error);
					}
		        };
		        // 使用 FileReader 读取文件并将结果作为数据 URL 返回
		        reader.readAsDataURL(file);
		    } else {
		        // 如果选择的不是图片，清空 img 元素的 src 属性
		        preview.src = '';
		    }
		});
		

	</script>
</html>